---
title: "R Notebook"
output: html_notebook
---
library(MASS)

How to justfiy the 
## Notes deseq2 generates zeros for foldchanges if the basesmean is zero, is, control mean = treatment mean =0
https://support.bioconductor.org/p/102052/

From past studies conducted on thiss reseach shows that the foldchange fot the data ha s long tail distribu heavy tak and a mean at zero so we simulated the data cfold changes susing the truncated causcy distrinbyit  whcih is also heavey tailed. 

```{r}
library(fitdistrplus)
## for bioconductor packages:
library(BiocManager)
if (FALSE) BiocManager::install(c("DESeq2", "edgeR"))
library(nlme)
library(truncdist)
library(DESeq2)
library(tidyverse)
library(patchwork)
library(bbmle)
n = 20; notu = 1000

Lfoldchange = rtrunc(notu, 'cauchy', a=-5, b=5, location=0, scale=0.5)
set.seed(101); foldchange = 2^Lfoldchange
control_mean = 2^rnorm(notu,5, 2); treat_mean = control_mean*foldchange
dispersion = runif(notu,0,1)

countmeans  =  rowMeans(data.frame(control_mean,treat_mean))
df = data.frame(countmeans ,dispersion)

data <- data.frame(apply(df,1,function(x){
          rnegbin(n=2*n, mu = x[1], theta = x[2])})) 
rownames(data)  <-  paste0("Sample",1:(2*n))
colnames(data)  <-  paste0("OTU",1:notu)
metadata =  data.frame(Sample=paste0("Sample",1:(2*n)),Groups=factor(rep(c("control", "treatment"),each=n)))




keep <- rowSums(data) >= 50; data <- data[keep,]

dds <- DESeqDataSetFromMatrix(t(data),metadata,~Groups) 
dds$Groups <- relevel(dds$Groups, ref = "control")
dds <- DESeq(dds)
res = data.frame(results(dds))

plot(Lfoldchange,res$log2FoldChange)
abline(0,1)
plot(log2(res$baseMean), res$log2FoldChange)

plot(log2(control_mean), res$log2FoldChange)

plot(log(countmeans), log(res$baseMean))
abline(0,1)

```

So we have simulated data, now we are goint plot the control abundances with foldchanges
Now we modle. SImuklate a negative binomila model and chech the best way to model the variation. 


